<% sortable = false unless defined? sortable
	needs_organization = false unless defined? needs_organization
	hierarchical = fasle unless defined? hierarchical
	if (['projects','folders'].include? controller_name and ['index','show','sort_tasks','create','update'].include? action_name)
	  @app_context ||= 'project'
  end
  if (controller_name == 'labels' and action_name == 'show')
    @app_context ||= 'label'
  end
	 %>
<div id="line_item_wrapper_<%= task.id %>" class="span-<% if hierarchical %>15 hierarchical<% else %>16<% end %> last" data-binding="hover_show_more" data-hover_div="[data-hover_id='task_line_item_<%= task.id %>']" data-hover_fade_time="50" data-hover_fadein_time="50">
<%= form_for task, :html => {
	:'data-ajax_behavior' => 'ajax_form',
	:'data-ajax_method' => 'PUT',
	:'data-ajax_success_callback' => "handleArchivementLink();hideModalMask();bindHoverShowMore();",
	:'data-ajax_success_element' => "task_#{task.id}"} do |f| %>
	<div class="span-<% if hierarchical %>15<% else %>16<% end %> last">
	<div class="span-<% if hierarchical %><% if task.shared? %>9<% else %>12<% end %><% else %><% if task.shared? %>10<% else %>13<% end %><% end %>">
	  <div class="task_line_item_left" data-hover_id="task_line_item_<%= task.id %>" style="display:none;">
  		<div class="line_item_height">
  		<%= f.check_box :state, {:'data-behavior' => 'auto_submit', :disabled => (task.project and task.project.archived?) ? 'disabled' : false}, task.archived? ? 'archived' : 'complete', 'active' %>
      </div>
    </div>
		<div class="line_item_text span-<% if hierarchical %><% if task.shared? %>8<% else %>11<% end %><% else %><% if task.shared? %>9<% else %>12<% end %><% end %> last task_line_item_middle">
      <a href="<%= task_url(task) %>" <% if task.done? %>class="completed"<% end %>><%= task.title %></a>
		</div>
	</div>
	<% if task.shared? %>
	<div class="span-3">
	  <div style="display:none" class="task_assignment_line_item_editor text_left" data-behavior="expander" data-state="expanded" data-id="task_<%= task.id %>_assignment">
	    <div class="span-3 last small">Assigned To:</div>
  		<%= f.select :user_id, task.project.all_users.map{|u| [u.handle,u.id]}, {}, :class => 'span-5', :'data-behavior' => 'auto_submit' %><br/>
  		<div class="span-3 last text_right small" data-behavior="expander" data-action="contract" data-id="task_<%= task.id %>_assignment">close</div>
	  </div>
    <div class="span-3 small line_fixed_width" onclick="void(0)" data-behavior="expander" data-action="expand" data-id="task_<%= task.id %>_assignment"><div class="overflow_fade">&nbsp;</div><div class="span-10 last small_padding"><%= task.user.handle %></div></div>
  </div>
	<% end %>
	<div class="span-3 last text_right">
    <% if ['project','folder'].include? @app_context or hierarchical %>
    <div class="span-2">
  	  <div style="display:none" class="task_assignment_line_item_editor" data-behavior="expander" data-state="expanded" data-id="task_<%= task.id %>_due_date">
        <%= f.text_field :due_date, :value => task.due_date.blank? ? Date.today.to_formatted_s(:input) : task.due_date.to_formatted_s(:input), :id => "task_#{task.id}_due_date_field", :'data-behavior' => 'date_picker', :class => 'span-6' %>
      	<div class="row_item button round small light" data-button="true" data-submit="true" onclick="void(0)">
      	  <div class="button_content">save</div>
      	</div>
    		<div class="text_with_button small" data-behavior="expander" data-action="contract" data-id="task_<%= task.id %>_due_date">or close</div>
  		</div>
      <div class="span-2 last text_left line_item_height small small_padding" data-behavior="expander" data-action="expand" data-id="task_<%= task.id %>_due_date"><% if task.due_date %><%= task.due_date.to_formatted_s(:short) %><% else %>add date<% end %></div>
    </div>
		<% else %>
		  <div class="span-2">
		    <% if task.project %>
		    <div id="task_<%= task.id %>_see_plan" class="span-2 line_item_control_expander line_item_control_expander_plan text_center small" data-behavior="expander" data-action="expand" data-id="task_project_id_expander_<%= task.id %>" data-hover_id="task_line_item_<%= task.id %>" data-hover_stop="true" style="display:none;">see plan</div>
        <div class="line_item_expand_control line_item_expand_control_plan text_left" data-behavior="expander" data-state="expanded" style="display:none;" data-id="task_project_id_expander_<%= task.id %>">
          <div class="small text_left">
            <%= link_to truncate_clean(task.project.title, :length => 256, :omission => '...', :max_word_length => 25), plan_url(task.project) %>
          </div><br/>
        <div class="line_item_expand_control_clickable" data-behavior="expander" data-action="contract" data-id="task_project_id_expander_<%= task.id %>" data-hover_rebind="true">close</div>
    		</div>
		    <% else %>
		    <div id="task_<%= task.id %>_add_plan" class="span-2 line_item_control_expander line_item_control_expander_plan text_center small" data-behavior="expander" data-action="expand" data-id="task_project_id_expander_<%= task.id %>" data-hover_id="task_line_item_<%= task.id %>" data-hover_stop="true" style="display:none;">add plan</div>
        <div class="line_item_expand_control line_item_expand_control_plan" data-behavior="expander" data-state="expanded" style="display:none;" data-id="task_project_id_expander_<%= task.id %>">
      		<%= f.grouped_collection_select :project_id, @this_user.folders, :projects, :title, :id, :title, {:include_blank => true}, :id => "task_project_id_select", :'data-role' => 'organize_item', :'data-behavior' => 'auto_submit', :'data-id' => task.id, :class => "span-3" %> <div class="line_item_expand_control_clickable" data-behavior="expander" data-action="contract" data-id="task_project_id_expander_<%= task.id %>" data-hover_rebind="true">close</div>
    		</div>
    		<% end %>
    	</div>
		<% end %>
    <% if needs_organization %>
      <%= hidden_field_tag 'needs_organization', true, :'data-role' => 'organize_item' %>
		<% end %>
		<div style="display:none;" class="line_item_height span-1 last" data-hover_id="task_line_item_<%= task.id %>">
		<a href="<%= task_url(task) %>"
			data-ajax_behavior="ajax_link"
			data-ajax_method="DELETE"
			data-ajax_success_callback="jQuery('#task_<%= task.id %>').remove();handleListDisplay();<% if task.project %>handleCount('project_<%= task.project_id %>_task_list','project_<%= task.project_id %>_task_list');<% end %>"
			data-ajax_data="{_method: 'DELETE'}"
			data-ajax_confirm="Are you sure you want to delete this task?"
			class="delete" data-role="delete">&otimes;</a>
  		<% if sortable or hierarchical %><span data-drag_handle="true" data-role="sortable_drag_handle" class="sortable_drag_handle">&equiv;</span><% end %>
		</div>
		<%= hidden_field_tag ('sortable', true) if (sortable == true) %>
		<%= hidden_field_tag 'partial', true %>
		<% if @app_context %>
  		<%= hidden_field_tag 'app_context', @app_context %>
    <% end %>
    <% if hierarchical %>
			<%= hidden_field_tag :hierarchical, 'hierarchical', :id => "task_#{task.id}_hierarchical" %>
    <% elsif sortable %>
		  <%= hidden_field_tag :sortable, 'sortable', :id => "task_#{task.id}_sortable" %>    
		<% end %>
	</div>
	</div>
  <% unless controller_name == 'labels' and ['show','edit'].include? action_name %>
  <div class="task_line_item_middle span-<% if hierarchical %>14<% else %>15<% end %> last">
    <div id="existing_label_wrapper_<%= task.id %>" data-behavior="expander" data-state="contracted" data-id="task_labels_expander_<%= task.id %>">
    <% for label in task.labels.for_user(@this_user) %><div class="label <%= label.color %>"><%= label.title %></div><% end %>
    </div>
    <div class="span-2">
      <% unless task.archived? or (task.project and task.project.archived?) %>
	    <div id="task_<%= task.id %>_edit_labels" class="span-2 line_item_control_expander text_center small" data-behavior="expander" data-action="expand" data-id="task_labels_expander_<%= task.id %>" data-hover_id="task_line_item_<%= task.id %>" data-hover_stop="true" style="display:none;">edit labels</div>
      <div name="task_labels_expander_<%= task.id %>" class="line_item_expand_control line_item_expand_control_labels" data-behavior="expander" data-state="expanded" style="display:none;" data-id="task_labels_expander_<%= task.id %>">
        <% for label in @this_user.labels %>
          <div class="label_wrapper <%= (task.labels.for_user(@this_user).include? label) ? 'selected' : '' %> margin_bottom" data-click_multi_select="true" data-click_id="task_labels">
            <div class="label <%= label.color %>" data-behavior="hidden_multi_proxy" data-hidden_field="labels" data-value="<%= label.id %>" data-id="task_<%= task.id %>_label_<%= label.id %>"><%= label.title %></div>
          </div>
          <% if task.labels.for_user(@this_user).include? label %>
            <input type="hidden" name="labels[]" value="<%= label.id %>" data-id="task_<%= task.id %>_label_<%= label.id %>">
          <% end %>
        <% end %>
        <div class="line_item_expand_control_clickable" data-behavior="expander" data-action="contract" data-id="task_labels_expander_<%= task.id %>" data-hover_rebind="true" data-hidden_proxy_close="true">close</div>
        <div id="task_label_submit_<%= task.id %>" class="line_item_expand_control_clickable" data-behavior="expander" data-action="contract" data-id="task_labels_expander_<%= task.id %>" data-hover_rebind="true" data-auto_submit="true" data-label_submit="true" data-hidden_proxy_save="true" style="display:none;">save</div>
  		</div>
  		<% end %>
		</div>
		<% if task.labels.for_user(@this_user).count == 0 %><div class="label_placeholder">&nbsp;</div><% end %>
  </div>
  <% end %>
<% end %>
</div>
