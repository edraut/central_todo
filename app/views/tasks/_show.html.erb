<% sortable = false unless defined? sortable
	needs_organization = false unless defined? needs_organization
	if (controller_name == 'projects' and action_name == 'show')
	  @app_context = 'project'
  end
  if (controller_name == 'situations' and action_name == 'show')
    @app_context = 'situation'
  end
	 %>
<%= form_for task, :html => {
	:'data-ajax_behavior' => 'ajax_form',
	:'data-ajax_method' => 'PUT',
	:'data-ajax_success_callback' => "handleArchivementLink();",
	:'data-ajax_success_element' => "task_#{task.id}"} do |f| %>
	<div class="<%= (['project','situation'].include? @app_context) ? 'span-13' : 'span-9' -%>">
		<%= f.hidden_field :priority, :id => "priority_#{task.id}", :'data-behavior' => 'auto_submit' %>
		<div data-behavior="check_box_proxy" data-check_box="priority_<%= task.id %>" class="check_box_proxy <% if task.priority? %>checked<% end %>">&lowast;</div>
		<div class="text_with_check_box_proxy">
		<%= f.check_box :state, {:'data-behavior' => 'auto_submit'}, task.archived? ? 'archived' : 'complete', 'active' %>
    </div>
		<div class="text_with_check_box_proxy <%= (['project','situation'].include? @app_context) ? 'span-12' : 'span-8' -%> last<% if task.overdue? %> overdue<% end %>">
		<%= link_to task.title, task_url(task), :style => task.done? ? 'text-decoration:line-through;' : nil %>
		</div>
	</div>
	<div class="<%= (['project','situation'].include? @app_context) ? 'span-5' : 'span-9' -%> last text-right">
		<% if needs_organization and @app_context != 'project' %>
  		<%= f.select :project_id, [['select plan',nil]] + @this_user.projects.active.map{|p| [p.title,p.id]}, {}, :'data-role' => 'organize_item', :'data-behavior' => 'auto_submit', :'data-id' => task.id, :class => "span-4" %>
    <% elsif @app_context != 'project' %>
    <div class="span-4 text-left">
      <% if task.project_id.nil? %>&mdash;<% else %>
      <%= link_to truncate_clean(task.project.title, {:length => 18, :omission => '-'}), plan_url(task.project_id) %>
      <% end %>
    </div>
		<% end %>
		<% if needs_organization and @app_context != 'situation' %>
  		<%= f.select :situation_id, [['select situation',nil]] + @this_user.situations.map{|s| [s.title,s.id]}, {}, :'data-role' => 'organize_item', :'data-behavior' => 'auto_submit', :'data-id' => task.id, :class => "span-4" %>
    <% elsif @app_context != 'situation' %>
    <div class="span-4 text-left">
      <% if task.situation_id.nil? %>&mdash;<% else %>
      <%= link_to truncate_clean(task.situation.title, {:length => 18, :omission => '-'}), situation_url(task.situation_id) %>
      <% end %>
    </div>
		<% end %>
    <% if needs_organization %>
      <%= hidden_field_tag 'needs_organization', true, :'data-role' => 'organize_item' %>
		<% end %>
		<a href="<%= task_url(task) %>"
			data-ajax_behavior="ajax_link"
			data-ajax_method="DELETE"
			data-ajax_success_callback="jQuery('#task_<%= task.id %>').remove();handleListDisplay();"
			data-ajax_data="{_method: 'DELETE'}"
			class="delete" data-role="delete">&otimes;</a>
		<% if sortable == true %><span data-role="sortable_drag_handle" class="sortable_drag_handle">&equiv;</span><% end %>
		<%= hidden_field_tag ('sortable', true) if (controller_name == 'projects' or sortable == true) %>
		<%= hidden_field_tag 'partial', true %>
		<%= hidden_field_tag '_method', 'PUT' %>
		<% if @app_context %>
  		<%= hidden_field_tag 'app_context', @app_context %>
		<% end %>
	</div>
<% end %>
