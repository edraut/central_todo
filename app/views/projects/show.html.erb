<div class="span-16" id="header_wrapper">
  <div class="span-16 last section_margin_top">
  	<h1>Plan </h1>
  </div>
  <%= render :partial => 'tabs' %>
</div>
<div class="span-18 last page_content">
<div class="span-16 last" style="display:none;" data-behavior="expander" data-state="expanded" data-id="new_task_form">
		<%= form_for @task do |f| %>
			<div class="span-12">
				<%= f.text_field :title, :id => "primary_input", :class => "span-12" %>
			</div>
			<div class="span-4 last">
				<%= f.hidden_field :user_id %>
				<%= f.hidden_field :project_id %>
				<%= f.hidden_field :state, :value => 'active' %>
				<%= hidden_field_tag :app_context, 'project' %>
				<%= f.submit "Add task to this Plan" %>
				<a href="#" data-behavior="expander" data-action="contract" data-id="new_task_form">cancel</a>
			</div>
		<% end %>
	</div>

  <% if @project.archived? %>
  <p>You archived this plan. If you would like to re-activate it, click on the 'edit plan' tab above and uncheck 'archived'.</p>
  <% else %>
	<div id="unarchived_item_list" class="span-16 last">
		<div id="task_list_heading" class="span-16 last">
			<div id="unarchived_item_heading" class="span-12<% if @project.all_complete %> completed<% end %>">
				<h2><%= @project.title %></h2>
			</div>
			<div class="span-4 last">
        	<div class="list_action attach_above" data-behavior="expander" data-state="contracted" data-id="new_task_form"><a href="#" data-behavior="expander" data-action="expand" data-id="new_task_form">add a task</a></div>
          <% if @project.tasks.unarchived.count == 0 and @project.tasks.count > 0 %>
          <div id="project_done" class="list_action attach_above"><%= render :partial => 'show_done', :locals => {:project => @project} %></div>
          <% end %>
			</div>
		</div>
		<div id="unarchived_items_wrapper" class="span-16 last section_wrapper" data-role="list">
      <div class="span-16 last line_item">
        <div class="span-9 text-center small">task title</div>
      </div>
      <div data-behavior="sortable" data-sort_url="<%= sort_tasks_plan_url(@project) %>">
			<% @project.tasks.unarchived.ordered.each_with_index do |task,index| %>
				<div class="span-16 last line_item" id="task_<%= task.id %>" data-role="list_item">
					<%= render :partial => '/tasks/show', :locals => {:task => task, :sortable => true, :needs_organization => true} %>
				</div>
			<% end %>
			</div>
		</div>
	</div>
  <div class="span-16 last">
    <div class="span-12 prepend-4 last">
      <div id="archive_completed_items" class="list_action attach_below" <% unless @project.tasks.complete.any? %>style="display: none;"<% end %>>
    	<%= link_to 'archive completed tasks', archive_completed_tasks_plan_url(@project),
    	 	:'data-ajax_behavior' => 'ajax_link',
    		:'data-ajax_method' => 'GET',
    		:'data-ajax_success_callback' => "handleArchivementSuccess(true);",
    		:'data-ajax_error_callback' => "jQuery(this).after('<div id=\"flash_notice\" class=\"flash_notice\"> Oops! We couldn't archive those completed tasks, please contact customer support.</div>');setTimeOut(\"jQuery('#flash_notice').fadeOut(1000);\",3000);" %> &darr;
    	</div>
			<% if @project.tasks.unarchived.with_due_date.count > 0 %>
		  <div class="list_action attach_below">
    		<%= link_to ('sort by due date', sort_tasks_plan_url(@project) + '?by_due_date=true') %>
      </div>
      <% end %>
    </div>
  </div>
	<% end %>
	<div id="archived_item_list" <% unless @project.tasks.archived.any? %>style="display:none;"<% end %> class="span-16 last section_margin_top" data-role="list">
		<div id="archived_item_heading" class="span-16 last">
			<h2>You got these done.</h2>
		</div>
		<div id="archived_items_wrapper" class="span-16 last archived section_wrapper">
      <div class="span-16 last line_item">
        <div class="span-9 text-center small">task title</div>
      </div>
			<% @archived_tasks.each_with_index do |task,index| %>
				<div class="span-16 last line_item" id="task_<%= task.id %>" data-role="list_item">
					<%= render :partial => '/tasks/show', :locals => {:task => task} %>
				</div>
			<% end %>
		</div>
  	<div class="span-17">
		<%= will_paginate @archived_tasks %>
    </div>
	</div>
</div>
<%= javascript_tag do %>
	jQuery(document).ready(function(){
  	bindExpanders();
		bindSortables();
		<% if params.has_key? :added_task %>
      jQuery("[data-behavior='expander'][data-state='contracted'][data-id='new_task_form']")
        .hide();
      jQuery("[data-behavior='expander'][data-state='expanded'][data-id='new_task_form']")
        .show();
      jQuery('#primary_input').focus();
		<% end %>
	})
<% end -%>