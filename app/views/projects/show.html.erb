<div class="span-18" id="header_wrapper">
  <div class="span-18 last section_margin_top">
  	<h1>Plan: <% if @project.done? %><span style="text-decoration:line-through;"><% end %> <%= @project.title %><% if @project.done? %></span><% end %></h1>
  </div>
  <%= render :partial => 'tabs' %>
</div>
<div class="span-19 last page_content">
	<div class="span-18 last" style="display:none;" data-behavior="expander" data-state="expanded" data-id="new_task_form">
		<%= form_for @task do |f| %>
			<div class="span-12">
				<%= f.text_field :title, :id => "primary_input", :class => "span-12" %>
			</div>
			<div class="span-6 last">
				<%= f.hidden_field :user_id %>
				<%= f.hidden_field :project_id %>
				<%= f.hidden_field :state, :value => 'active' %>
				<%= hidden_field_tag :app_context, 'project' %>
				<%= f.submit "Add task to this Plan" %>
				<a href="#" data-behavior="expander" data-action="contract" data-id="new_task_form">cancel</a>
			</div>
		<% end %>
	</div>

  <% unless @project.done? %>
	<div id="unarchived_item_list" class="span-18 last">
		<div id="task_list_heading" class="span-18 last">
			<div id="unarchived_item_heading" class="span-6">
				<h2><% if @project.tasks.unarchived.any? %>Get these done.<% else %>No active tasks.<% end %></h2>
			</div>
			<div class="span-12 last">
        	<div class="list_action attach_above" data-behavior="expander" data-state="contracted" data-id="new_task_form"><a href="#" data-behavior="expander" data-action="expand" data-id="new_task_form">add a new task</a></div>
  				<% if @project.tasks.unarchived.with_due_date.count > 0 %>
  			  <div class="list_action attach_above">
        		<%= link_to ('sort by due date', sort_tasks_plan_url(@project) + '?by_due_date=true') %>
          </div>
          <% end %>
			</div>
		</div>
		<div id="unarchived_items_wrapper" class="span-18 last section_wrapper" data-behavior="sortable" data-sort_url="<%= sort_tasks_plan_url(@project) %>" data-role="list">
			<% for task in @project.tasks.unarchived.ordered %>
				<div class="span-18 last" id="task_<%= task.id %>" data-role="list_item">
					<%= render :partial => '/tasks/show', :locals => {:task => task, :sortable => true} %>
				</div>
			<% end %>
		</div>
	</div>
	<% end %>
  <div class="span-18 last">
    <div class="span-12 prepend-6 last">
      <div id="archive_completed_items" class="list_action attach_below" <% unless @project.tasks.complete.any? %>style="display: none;"<% end %>>
    	<%= link_to 'archive completed tasks', archive_completed_tasks_plan_url(@project),
    	 	:'data-ajax_behavior' => 'ajax_link',
    		:'data-ajax_method' => 'GET',
    		:'data-ajax_success_callback' => "handleArchivementSuccess(true);",
    		:'data-ajax_error_callback' => "jQuery(this).after('<div id=\"flash_notice\" class=\"flash_notice\"> Oops! We couldn't archive those completed tasks, please contact customer support.</div>');setTimeOut(\"jQuery('#flash_notice').fadeOut(1000);\",3000);" %> &darr;
    	</div>
    </div>
  </div>
	<div id="archived_item_list" <% unless @project.tasks.archived.any? %>style="display:none;"<% end %> class="span-18 last section_margin_top" data-role="list">
		<div id="archived_item_heading" class="span-18 last">
			<h2>You got these done.</h2>
		</div>
		<div id="archived_items_wrapper" class="span-18 last archived section_wrapper">
			<% for task in @project.tasks.archived %>
				<div class="span-18 last" id="task_<%= task.id %>" data-role="list_item">
					<%= render :partial => '/tasks/show', :locals => {:task => task} %>
				</div>
			<% end %>
		</div>
	</div>
</div>
<%= javascript_tag do %>
	bindExpanders();
	jQuery(document).ready(function(){
		bindSortables();
	})
<% end -%>